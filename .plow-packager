#!/bin/bash

#
# This script creates a plow source tar.gz package
# from the latest svn tags/version-x.y.z directory.
#

dir=$(pwd)

pdir="/tmp/plow-packager"
mkdir -p ${pdir}                            || exit 1
cd ${pdir}                                  || exit 1
_versions=$(svn ls --verbose svn://svn.berlios.de/plow/tags |\
           grep "version-" |\
           sort -nr |\
	   awk -F' ' '{print $6}')
_version=$(echo ${_versions} | awk -F' ' '{print $1}' | tr -d '/')
svn checkout svn://svn.berlios.de/plow/tags/${_version} || exit 1
cd ${_version}                                          || exit 1

name='plow'
version=$(echo ${_version} | awk -F'version-' '{print $2}')
if [[ -z "${version}" ]]; then
	echo "Something went wrong."
	exit 1
fi
package="${name}-${version}"
rm -rf   /tmp/${package}
mkdir -p /tmp/${package} || exit 1

cp AUTHORS ChangeLog COPYING NEWS README TODO plow.1 Makefile /tmp/${package}
if test "$?" -eq 1; then
	echo  "There are some files missing."
	exit 1
fi

patchfile="/tmp/${package}/Makefile.patch"
echo "10a11,12"                                         >> ${patchfile}
echo "> VERSION        = ${version}"                    >> ${patchfile}
echo "> CXXFLAGS      += -DVERSION=\\\"\${VERSION}\\\"" >> ${patchfile}
patch /tmp/${package}/Makefile <${patchfile}
rm -f ${patchfile}

mkdir /tmp/${package}/src
cp src/*.cpp /tmp/${package}/src
cp src/*.h /tmp/${package}/src
mkdir /tmp/${package}/bin

cd /tmp
tar czf ${package}.tar.gz ${package}
cd ${dir}
mv /tmp/${package}.tar.gz ./
rm -rf /tmp/${package}
rm -rf /tmp/plow-packager
echo "${dir}/${package}.tar.gz created ..."

